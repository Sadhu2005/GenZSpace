name: 📱 Deploy GenZSpace App to Google Play Store

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'ios/**'
      - 'pubspec.yaml'
      - 'firebase.json'
      - 'firestore.rules'
      - 'firestore.indexes.json'
      - 'storage.rules'
      - '.github/workflows/app-deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'Deploy App to Google Play Store'
        required: true
        default: 'app'
        type: choice
        options:
          - app

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'
  PACKAGE_NAME: 'com.anu.GenZSpace'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ☕ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: 🎯 Setup Flutter
      uses: subosito/flutter-action@v4
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: 📦 Get Flutter dependencies
      run: flutter pub get

    - name: 🔍 Analyze Flutter code
      run: flutter analyze --no-fatal-infos

    - name: 🧪 Run Flutter tests
      run: flutter test --coverage

    - name: ⬆️ Get current version
      id: version
      run: |
        VERSION_NAME=$(grep 'version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
        VERSION_CODE=$(grep 'version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f2)
        echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
        echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
        echo "version-name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "version-code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "📱 App Version: $VERSION_NAME"
        echo "📱 Version Code: $VERSION_CODE"

    - name: 🏗️ Build Android App Bundle (AAB)
      run: |
        echo "🏗️ Building Android App Bundle..."
        flutter build appbundle --release
        echo "✅ Build completed successfully"

    - name: 🔍 Verify AAB file
      run: |
        echo "🔍 Checking for AAB file..."
        if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
          echo "✅ AAB file found: build/app/outputs/bundle/release/app-release.aab"
          ls -la build/app/outputs/bundle/release/app-release.aab
        else
          echo "❌ AAB file not found in expected location"
          echo "📁 Searching for AAB files..."
          find . -name "*.aab" -type f
          exit 1
        fi

    - name: 🚀 Upload to Google Play Store Internal Testing
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJson: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: ${{ env.PACKAGE_NAME }}
        releaseFile: build/app/outputs/bundle/release/app-release.aab
        track: internal
        status: completed
        inAppUpdatePriority: 0

    - name: ✅ Notify Success
      if: success()
      run: |
        echo "🚀 GenZSpace app deployed successfully to Google Play Store!"
        echo "📱 Package: ${{ env.PACKAGE_NAME }}"
        echo "📊 Version: ${{ env.VERSION_NAME }} (${{ env.VERSION_CODE }})"
        echo "🎯 Track: Internal Testing"
        echo "📱 Your app will be available for testing in a few minutes!"

    - name: ❌ Notify Failure
      if: failure()
      run: |
        echo "❌ GenZSpace app deployment failed!"
        echo "Please check the logs for more details."
        echo "Common issues:"
        echo "- Service account JSON not configured"
        echo "- Package name mismatch"
        echo "- Google Play Console permissions"