name: ðŸš€ Deploy to Google Play Store Internal Testing

on:
  push:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'
  PACKAGE_NAME: 'com.anu.GenZSpace'

jobs:
  deploy-to-play-store:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: â˜• Setup Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: ðŸŽ¯ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ðŸ“¦ Get dependencies
      run: |
        flutter pub get
        
    - name: ðŸ” Validate Flutter setup
      run: |
        flutter doctor -v
        flutter analyze --no-fatal-infos || echo "âš ï¸ Analysis completed with warnings"

    - name: â¬†ï¸ Auto-increment version
      id: version
      run: |
        CURRENT_VERSION=$(grep 'version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)
        CURRENT_CODE=$(grep 'version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f2)
        NEW_CODE=$((CURRENT_CODE + 1))
        sed -i "s/version: $CURRENT_VERSION+$CURRENT_CODE/version: $CURRENT_VERSION+$NEW_CODE/" pubspec.yaml
        echo "VERSION_NAME=$CURRENT_VERSION" >> $GITHUB_ENV
        echo "VERSION_CODE=$NEW_CODE" >> $GITHUB_ENV
        echo "ðŸ“± Version: $CURRENT_VERSION+$NEW_CODE"

    - name: ðŸ—ï¸ Build AAB with Gradle
      uses: gradle/gradle-build-action@v2
      with:
        build-root-directory: android
        gradle-version: 8.11.1
        arguments: clean :app:bundleRelease -x lint --no-daemon --info
      continue-on-error: false

    - name: âœ… Verify AAB Build Success
      run: |
        if [ -f "android/app/build/outputs/bundle/release/app-release.aab" ]; then
          echo "âœ… AAB build completed successfully"
          ls -lh android/app/build/outputs/bundle/release/app-release.aab
        else
          echo "âŒ AAB file not found in expected location"
          exit 1
        fi

    - name: ðŸ” Locate AAB for Upload
      id: find_aab
      run: |
        echo "ðŸ” Locating AAB file for upload..."
        
        # Check multiple possible locations
        ANDROID_AAB="android/app/build/outputs/bundle/release/app-release.aab"
        FLUTTER_AAB="build/app/outputs/bundle/release/app-release.aab"
        
        if [ -f "$ANDROID_AAB" ]; then
          echo "âœ… Found AAB: $ANDROID_AAB"
          echo "aab_path=$ANDROID_AAB" >> $GITHUB_OUTPUT
          echo "aab_size=$(stat -c%s "$ANDROID_AAB")" >> $GITHUB_OUTPUT
          ls -lh "$ANDROID_AAB"
        elif [ -f "$FLUTTER_AAB" ]; then
          echo "âœ… Found AAB: $FLUTTER_AAB"
          echo "aab_path=$FLUTTER_AAB" >> $GITHUB_OUTPUT
          echo "aab_size=$(stat -c%s "$FLUTTER_AAB")" >> $GITHUB_OUTPUT
          ls -lh "$FLUTTER_AAB"
        else
          echo "âŒ AAB file not found in standard locations"
          echo "ðŸ” Debug: Searching all .aab files..."
          find . -name "*.aab" -type f -exec ls -lh {} \;
          echo "ðŸ“‚ Checking build directories..."
          ls -la android/app/build/outputs/bundle/ 2>/dev/null || echo "Android build directory not found"
          ls -la build/app/outputs/bundle/ 2>/dev/null || echo "Flutter build directory not found"
          exit 1
        fi

    - name: ðŸ” Validate Google Play Credentials
      run: |
        if [ -z "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" ]; then
          echo "âŒ Error: GOOGLE_PLAY_SERVICE_ACCOUNT_JSON secret not configured"
          echo "ðŸ”§ Please add your Google Play Service Account JSON to GitHub secrets"
          echo "ðŸ’¡ Go to Settings > Secrets > Actions > Add repository secret"
          exit 1
        else
          echo "âœ… Google Play credentials found"
          echo "ðŸ“¦ JSON length: ${#{{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}}"
        fi

    - name: ðŸš€ Upload to Google Play Store Internal Testing
      uses: r0adkll/upload-google-play@v1.1.0
      with:
        serviceAccountJson: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: ${{ env.PACKAGE_NAME }}
        releaseFile: ${{ steps.find_aab.outputs.aab_path }}
        track: internal
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“± Verification & Summary
      run: |
        echo ""
        echo "ðŸŽ‰ =========================================="
        echo "ðŸš€ GenZSpace Successfully Deployed!"
        echo "==========================================="
        echo "ðŸ“± App: GenZSpace"
        echo "ðŸ“¦ Package: ${{ env.PACKAGE_NAME }}"
        echo "ðŸ†• Version: ${{ env.VERSION_NAME }} (${{ env.VERSION_CODE }})"
        echo "ðŸ“ AAB Size: ${{ steps.find_aab.outputs.aab_size }} bytes"
        echo "ðŸŽ¯ Track: Internal Testing"
        echo "==========================================="
        echo ""
        echo "ðŸ“± How to test on your phone:"
        echo "1. Open Google Play Store"
        echo "2. Search for 'GenZSpace'"
        echo "3. Look for 'Internal testing' version"
        echo "4. Install/Update the app"
        echo ""
        echo "â±ï¸ Wait 5-10 minutes for processing"
        echo "âœ… Check Google Play Console for upload status"
        echo "==========================================="

    - name: ðŸ’¬ Upload Success Notification
      if: success()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸš€ GenZSpace Deployed Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Your app is now available for **Internal Testing**!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Testing Instructions:" >> $GITHUB_STEP_SUMMARY
        echo "1. Open Google Play Store on your phone" >> $GITHUB_STEP_SUMMARY
        echo "2. Search for **GenZSpace**" >> $GITHUB_STEP_SUMMARY
        echo "3. Download/Update from Internal Testing track" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Release Details:" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ env.VERSION_NAME }} (${{ env.VERSION_CODE }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: ${{ env.PACKAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: Ready for testing" >> $GITHUB_STEP_SUMMARY
        echo "- **Track**: Internal Testing" >> $GITHUB_STEP_SUMMARY

    - name: âŒ Upload Failed Notification
      if: failure()
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs above for errors and try again." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Common issues:" >> $GITHUB_STEP_SUMMARY
        echo "- Invalid Google Play Service Account JSON" >> $GITHUB_STEP_SUMMARY
        echo "- Package name mismatch" >> $GITHUB_STEP_SUMMARY
        echo "- Build failures" >> $GITHUB_STEP_SUMMARY
